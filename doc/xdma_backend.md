# XDMA backend

The XDMA backend interfaces the [Xilinx DMA Subsystem for PCI Express](https://www.xilinx.com/support/documentation/ip_documentation/xdma/v4_1/pg195-pcie-dma.pdf) through the [Xilinx XDMA driver](https://www.xilinx.com/Attachment/Xilinx_Answer_71435_XDMA_Debug_Guide.pdf).

## Prerequisites

This backend requires the XDMA device files to be in a directory structure like this:

```
$ tree /dev/xdma 
/dev/xdma
└── slot4
    ├── c2h0 -> ../../xdma0_c2h_0
    ├── control -> ../../xdma0_control
    ├── events0 -> ../../xdma0_events_0
    ├── events1 -> ../../xdma0_events_1
    ...
    ├── events15 -> ../../xdma0_events_15
    ├── h2c0 -> ../../xdma0_h2c_0
    ├── user -> ../../xdma0_user
    └── xvc -> ../../xdma0_xvc
```

The `slot4` directory shown here corresponds to the 4th AMC slot in the MicroTCA crate. The device path parameter for the backend must match the relative path under `/dev`; for this example the dmap entry must read `xdma:xdma/slot4`.

Install TechLab's xdma metapackage (either as Debian package `xdma-dkms` from [doocs.desy.de](https://doocs.desy.de/pub/doocs/dists/) or [from source](https://github.com/MicroTCA-Tech-Lab/xdma-metapackage)) to make sure udev rules are present to match the device file paths expected by this backend.

## Mapping of XDMA driver interfaces

This backend uses following device files to communicate with the XDMA driver:

| File Name          | Function                        | Description                                                                    |
|--------------------|---------------------------------|--------------------------------------------------------------------------------|
| `user`             | AXI-Lite Master interface       | Control/status register access to cores/peripherals on the AXI bus             |
| `c2h0`..`3`        | AXI MM DMA, card to host        | DMA transfer from FPGA memory to the host                                      |
| `h2c0`..`3`        | AXI MM DMA, host to card        | DMA transfer from the host to FPGA memory                                      |
| `event0`..`15`     | User interrupts                 | Interrupts generated by user logic, received by the host                       |

The different data interfaces are addressed using BAR numbers in the mapfile. However, these BAR numbers are a matter of convention and do not reflect the actual PCIe BAR used by the XDMA driver.

### AXI-Lite Master interface

The AXI-Lite Master interface is addressed using BAR 0 in the mapfile.

### AXI MM DMA interface

The DMA channels 0..3 are addressed using BARs 13..16 (0x0d..0x10), respectively.

### Interrupt lines (events)

The 'channel interrupts' (for AXI MM DMA) are handled by the driver itself w/o any user intervention. The 'user interrupts' are forwarded to the event files shown above and can be used in this backend for event-driven ("push-type") register reads. To connect a register to an user interrupt, the `INTERRUPT` specifier has to be used in the mapfile. The interrupt controller number is always zero here, so the specifier is `INTERRUPT0:n`, e.g. `INTERRUPT0:4` for user interrupt 4.

