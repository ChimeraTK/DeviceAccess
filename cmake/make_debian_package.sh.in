#!/bin/bash

#Check that the mtca4u_deviceacces_BUILDVERSION variable is set, otherwise reject creating a package
if [ -z "$mtca4u_deviceaccess_BUILDVERSION" ]; then
    echo Environment variable 'mtca4u_deviceaccess_BUILDVERSION' not set or empty. You need it to make a debian package!
    exit 1
fi

#drop out of the script if anything goes wrong (e.g. non-existen git tag)
set -e

#Create a working directory in order not to merge with the rest in the build directory
rm -rf debian_package
mkdir debian_package
cd debian_package

#Check out the correct tag from the master git repository.
#The local directory name has to follow the debian convention
# lowecasepackagenname_package.ver.sion
BUILD_DIR_NAME=libmtca4u-deviceaccess_@mtca4u-deviceaccess_FULL_LIBRARY_VERSION@
#svn export https://svnsrv.desy.de/public/mtca4u/deviceaccess/tags/@mtca4u-deviceaccess_VERSION@ libmtca4u-deviceaccess_@mtca4u-deviceaccess_FULL_LIBRARY_VERSION@
git clone https://github.com/ChimeraTK/DeviceAccess.git ${BUILD_DIR_NAME}
( cd  ${BUILD_DIR_NAME} &&\
  git checkout /@mtca4u-deviceaccess_VERSION@ &&\
  rm -rf .git )
#Debian convention: file has to end on .orig.tar.gz
tar -czf  ${BUILD_DIR_NAME}.orig.tar.gz  ${BUILD_DIR_NAME}

#Copy the prepared debian packaging config files to the source code 
#directroy
cp -r ../debian_from_template  ${BUILD_DIR_NAME}/debian
cd ${BUILD_DIR_NAME}

#The package versions for doocs / Ubuntu contain the codename of the distribution. Get it from the system.
CODENAME=`lsb_release -c | sed "{s/Codename:\s*//}"`

#Before building the package we will update the changelog. This is easier from a shell script
#because debchange does the right format and the current date, user name and email automatically for us.
#Use the NAME and EMAIL environment variables to get correct values if needed (usually the email is
# user@host instead of first.last@institute, for instance killenb@mskpcx18571.desy.de instead of martin.killenberg@desy.de).
debchange --create --package libmtca4u-deviceaccess -v @mtca4u-deviceaccess_FULL_LIBRARY_VERSION@-${mtca4u_deviceaccess_BUILDVERSION} --distribution ${CODENAME} Debian package for MTCA4U deviceaccess @mtca4u-deviceaccess_VERSION@

#Now everything is prepared and we can actually build the package.
#If you have a gpg signature you can remove the -us and -uc flags and sign the package.
dpkg-buildpackage -rfakeroot -us -uc
